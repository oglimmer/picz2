FROM node AS builder

COPY . /opt/project-base

RUN cd /opt/project-base/frontend && npm i && npm run build

FROM nginx:latest

COPY --from=builder /opt/project-base/frontend/dist/index.html /usr/share/nginx/html
#COPY --from=builder /opt/project-base/frontend/dist/favicon.ico /usr/share/nginx/html
COPY --from=builder /opt/project-base/frontend/dist/assets /usr/share/nginx/html/assets
COPY --from=builder /opt/project-base/frontend/dist/build-info.json /usr/share/nginx/html/build-info.json

# Copy nginx configurations
COPY frontend/nginx-main.conf /etc/nginx/nginx.conf
COPY frontend/nginx.conf /etc/nginx/conf.d/default.conf

# Create temp directories for nginx and set permissions
RUN mkdir -p /tmp/client_temp /tmp/proxy_temp_path /tmp/fastcgi_temp \
    /tmp/uwsgi_temp /tmp/scgi_temp && \
    chown -R 10001:10001 /tmp/client_temp /tmp/proxy_temp_path /tmp/fastcgi_temp \
    /tmp/uwsgi_temp /tmp/scgi_temp /var/cache/nginx && \
    chmod -R 755 /tmp/client_temp /tmp/proxy_temp_path /tmp/fastcgi_temp \
    /tmp/uwsgi_temp /tmp/scgi_temp

# Ensure nginx can write to necessary directories
RUN touch /var/run/nginx.pid && \
    chown -R 10001:10001 /var/run/nginx.pid /var/cache/nginx /usr/share/nginx/html

USER 10001

EXPOSE 8080
